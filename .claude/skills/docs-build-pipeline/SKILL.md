---
name: docs-build-pipeline
description: >
  How the Prefab docs build pipeline works: the scripts in
  docs/_preview-build/, what they do, and how to update them. Use when
  modifying build scripts, debugging doc generation failures, adding new
  doc source paths, updating CSS safelists, or troubleshooting preview
  rendering.
---

## Overview

`prefab dev build-docs` runs the full pipeline. The scripts live in
`docs/_preview-build/` and execute in this order:

1. **build:embed** (`npm run build:embed` in `renderer/`) — builds
   `renderer/src/embed.tsx` as a self-contained ES module via Vite library
   mode. Output: `docs/embed.js`. This is what `ComponentPreview` loads at
   runtime to render component trees in shadow DOM. The build inlines all
   dependencies (React, Radix, Recharts, Tailwind CSS) into a single file.
   Config: `renderer/vite.config.embed.ts`.
2. **render_previews.py** — finds `<ComponentPreview auto>` blocks in MDX
   files, executes the Python code, serializes component trees to JSON,
   rebuilds the CodeGroup interior (Python + JSON tabs) and the `json`
   prop on the tag
3. **generate_content.py** — concatenates all rendered MDX into
   `content.html` for Tailwind to scan
4. **Tailwind CSS build** — compiles `input.css` → scoped CSS using the
   content.html and MDX files as sources
5. **scope_css.py** — rewrites the compiled CSS to scope under shadow DOM
   (`:host` selectors)
6. **generate_playground_bundle.py** — builds the playground JSON bundle
7. **extract_examples.py** — extracts Python code blocks from MDX files
   into `renderer/src/playground/examples.json`
8. **generate_protocol_pages.py** — introspects Pydantic models and writes
   one MDX page per component/action into `docs/protocol/`
9. **generate_protocol_ref.py** — updates `## Protocol Reference` sections
   in component MDX files with Card/ParamField markup from schemas

## Source Paths

Scripts read MDX files from `docs/` (components, actions, patterns, etc.)
and write generated output to:
- `docs/embed.js` — self-contained renderer module (built from `renderer/src/embed.tsx`)
- `docs/protocol/` — autogenerated protocol reference pages
- `docs/_preview-build/content.html` — concatenated content for Tailwind
- `renderer/src/playground/examples.json` — playground examples
- `renderer/src/playground/bundle.json` — playground bundle

If the docs directory structure changes, update the path constants in each
script. Key locations:
- `render_previews.py`: `docs_dir = Path(__file__).resolve().parents[1]`
- `generate_protocol_pages.py`: `PROTOCOL_DIR = Path(__file__).resolve().parents[1] / "protocol"`
- `extract_examples.py`: `docs_dir = root / "docs"`
- `input.css`: `@source "../**/*.mdx"` glob

## CSS Safelist

`renderer/src/index.css` has `@source inline(...)` lines that safelist
Tailwind classes available via `cssClass`. When adding new layout utilities
or CSS class patterns to components, extend the appropriate safelist line.

Current safelists cover: gap, grid-cols, items-*, justify-*, place-items-*,
flex utilities, spacing, sizing, typography, colors, and more.

## Common Tasks

**Adding a new component:** After writing the Python model and renderer,
run `prefab dev build-docs` to generate the protocol page in `docs/protocol/`.
Then write the component doc in `docs/components/`.

**Changing doc directory structure:** Update path constants in all scripts
listed under Source Paths above, plus the `@source` glob in `input.css`.

**Debugging blank previews:** Usually means the Python code block in
`<ComponentPreview auto>` raised an error during `render_previews.py`.
Run the script directly to see the traceback:
```bash
uv run docs/_preview-build/render_previews.py
```

**Previews render but look wrong in browser:** Check whether the needed
Tailwind classes are safelisted in `renderer/src/index.css`. Dynamic
classes passed via `cssClass` must appear in a safelist to be included
in the compiled CSS.

## Embed Module Architecture

`docs/embed.js` is a self-contained ES module built from
`renderer/src/embed.tsx` via Vite library mode
(`renderer/vite.config.embed.ts`). It exports a single function
`mountPreview(host, json, options)` that creates a shadow DOM, injects
Tailwind CSS, and renders a component tree with React.

All dependencies (React, Radix, Recharts, Tailwind CSS) are bundled
inline — no external imports. The CSS is inlined as a string via Vite's
`?inline` import and processed through the `tailwindShadowDom` plugin
(shared in `renderer/vite-plugins.ts`) to strip `@property` declarations
that don't work in shadow DOM.

`docs/snippets/component-preview.mdx` loads this module via dynamic
`import("/embed.js")` at runtime. The `new Function("u", "return
import(u)")` wrapper prevents Mintlify's bundler from trying to resolve
the import at build time.

The same library-mode build mechanism could serve air-gapped MCP app
distribution: ship the built bundle alongside an MCP server so the client
can render Prefab UI without a live server or CDN.
