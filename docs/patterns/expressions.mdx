---
title: Expressions
description: The expression language that powers templates, conditions, and filters.
icon: function
---

Prefab includes a small expression language that evaluates inside `{{ }}` templates, `visible_when` conditions, and `ForEach` filters. It handles display-time computation — arithmetic, comparisons, conditional text, formatting — so you don't need a server round-trip for trivial logic.

The expression language is deliberately limited. It computes scalar values: numbers, strings, booleans. It cannot construct objects or arrays, call arbitrary functions, or produce side effects. If you need structural mutations (adding to a list, updating a nested field), that's an [action](#actions). If you need complex logic, that's a [ToolCall](/actions/call-tool).

## Templates

Every string prop on every component supports `{{ }}` template expressions. When the renderer encounters `{{ expr }}` in a string value, it evaluates the expression against the current state and replaces it with the result.

```python
from prefab_ui.components import Text

Text("Hello, {{ name }}!")
Text("Total: {{ price * quantity | currency }}")
Text("{{ items.length }} item{{ items.length != 1 ? 's' : '' }} in your cart")
```

When a template is the *entire* string value, the resolved type is preserved. `"{{ count }}"` resolves to the number `42`, not the string `"42"`. This matters for props that expect numbers or booleans. Mixed templates always produce strings: `"Count: {{ count }}"` produces `"Count: 42"`.

## Operators

The full set of supported operators, listed from lowest to highest precedence:

| Precedence | Operators | Example |
|-----------|-----------|---------|
| Ternary | `? :` | `{{ active ? 'On' : 'Off' }}` |
| Logical OR | `\|\|` | `{{ a \|\| b }}` |
| Logical AND | `&&` | `{{ loggedIn && isAdmin }}` |
| Logical NOT | `!` | `{{ !hidden }}` |
| Comparison | `==` `!=` `>` `<` `>=` `<=` | `{{ count > 0 }}` |
| Addition | `+` `-` | `{{ count + 1 }}` |
| Multiplication | `*` `/` | `{{ price * quantity }}` |

The `+` operator does double duty: arithmetic on numbers, concatenation on strings. `{{ 2 + 3 }}` produces `5`; `{{ first + ' ' + last }}` produces `"Arthur Dent"`.

Parentheses override precedence: `{{ (a + b) * c }}`.

## Dot Paths

Use dot notation to reach into nested objects:

```python
from prefab_ui.components import Text

Text("{{ user.address.city }}")
Text("{{ order.items.length }} items")
```

`.length` works on both arrays and strings.

## Pipes

Add a pipe after an expression to transform the result. Pipes are pure formatting functions — they take a value in and return a display value out.

```python
from prefab_ui.components import Column, Text

with Column(gap=2):
    Text("{{ score | percent }}")         # 0.75 -> "75%"
    Text("{{ score | percent:1 }}")       # 0.756 -> "75.6%"
    Text("{{ price | number:2 }}")        # 1234 -> "1,234.00"
    Text("{{ price | currency }}")        # 1234 -> "$1,234.00"
    Text("{{ price | currency:EUR }}")    # 1234 -> "EUR 1,234.00"
    Text("{{ date | date }}")             # ISO string -> "Jan 15, 2025"
    Text("{{ date | date:short }}")       # -> "1/15/2025"
    Text("{{ date | date:long }}")        # -> "January 15, 2025"
    Text("{{ date | time }}")             # -> "2:30 PM"
    Text("{{ date | datetime }}")         # -> "Jan 15, 2025, 2:30 PM"
    Text("{{ name | upper }}")            # "arthur" -> "ARTHUR"
    Text("{{ name | lower }}")            # "ARTHUR" -> "arthur"
    Text("{{ items | length }}")          # [1,2,3] -> 3
    Text("{{ tags | join:, }}")           # ["a","b"] -> "a, b"
    Text("{{ bio | truncate:80 }}")       # Clamp to 80 characters
    Text("{{ name | default:Anonymous }}") # Fallback if null/undefined
    Text("{{ items | first }}")           # First element of array
    Text("{{ items | last }}")            # Last element of array
    Text("{{ delta | abs }}")             # Absolute value
```

### All Pipes

| Pipe | Argument | Description |
|------|----------|-------------|
| `percent` | decimal places (default 0) | Multiply by 100, append `%` |
| `number` | decimal places | Locale-formatted number |
| `currency` | currency code (default USD) | Locale-formatted currency |
| `date` | `short` \| `long` (default medium) | Format date string |
| `time` | | Format time string |
| `datetime` | | Format date and time |
| `upper` | | Uppercase string |
| `lower` | | Lowercase string |
| `length` | | Array or string length |
| `join` | separator (default `, `) | Join array elements into string |
| `truncate` | max length | Clamp string, append `...` if truncated |
| `default` | fallback value | Use fallback if value is null/undefined |
| `first` | | First element of array |
| `last` | | Last element of array |
| `abs` | | Absolute value |

Pipes can be chained: `{{ name | lower | truncate:20 }}`.

## Where Expressions Work

The same expression language is used in three contexts:

### `{{ }}` Templates

Any string prop on any component. Evaluates the expression and substitutes the result.

```python
Text("{{ price * quantity | currency }}")
Badge("{{ status | upper }}", variant="{{ statusVariant }}")
```

### `visible_when`

A prop on every component that controls whether it renders. The expression must evaluate to a truthy or falsy value.

```python
from prefab_ui.components import Alert, AlertTitle
from prefab_ui import ToggleState

Alert("Out of stock", visible_when="inventory == 0")
Alert("Low stock warning", visible_when="inventory > 0 && inventory < 10")
```

### ForEach `filter`

Controls which items in a list are rendered. The expression evaluates per-item with access to both the item's fields and global state.

```python
from prefab_ui.components import ForEach, Checkbox, Text, Column

with Column(gap=3):
    Checkbox(label="Hide completed", name="hideDone",
             on_change=ToggleState("hideDone"))
    with ForEach("todos", filter="!done || !hideDone"):
        Text("{{ text }}")
```

When `hideDone` is false, all items render. When true, only items where `done` is false render. The data stays in state untouched — filtering is a view concern.


## Context Variables

Expressions resolve values from the current context. What's available depends on where the expression runs.

### Global State

Always available. Values set by `AppResult(state={...})`, named form controls, `SetState`, and `ToolCall` with `result_key`.

```python
from prefab_ui import AppResult

# These become available as {{ count }}, {{ name }}, etc.
AppResult(state={"count": 0, "name": "Arthur"}, view=...)
```

Named form controls sync automatically — `Input(name="city")` updates `{{ city }}` on every keystroke.

### Local Scope

The [State](/components/state) component and [ForEach](/components/foreach) provide scoped values that shadow global state within their subtree.

```python
from prefab_ui.components import State, Text

with State(greeting="Don't Panic"):
    Text("{{ greeting }}")  # Resolves from local scope
```

### `$event`

Available inside action specs. Contains the value from the triggering interaction — what that means depends on the component:

| Component | `$event` value |
|-----------|---------------|
| Slider | Current position (number) |
| Input / Textarea | Current text (string) |
| Checkbox / Switch | Checked state (boolean) |
| Select | Selected value (string) |
| RadioGroup | Selected value (string) |
| Button | `undefined` |

```python
from prefab_ui import SetState

Slider(name="volume", on_change=SetState("volume"))
# SetState defaults to "{{ $event }}", capturing the slider position
```

### `$error`

Available inside `on_error` callbacks. Contains the error message from the failed action.

```python
from prefab_ui import ToolCall, ShowToast

Button("Save", on_click=ToolCall(
    "save_data",
    on_error=ShowToast("Failed: {{ $error }}", variant="error"),
))
```

### `$index`

Available inside [ForEach](/components/foreach) iterations. The zero-based index of the current item.

```python
from prefab_ui.components import ForEach, Text

with ForEach("items"):
    Text("{{ $index + 1 }}. {{ name }}")
    # Renders: "1. First", "2. Second", etc.
```

`$index` is how actions target specific list items from inside a loop — see [RemoveState](#removestate) and [SetState path support](#path-support).

### `$item`

Available inside [ForEach](/components/foreach) iterations. A reference to the entire current item object. Individual fields are also available directly (e.g., `{{ name }}` instead of `{{ $item.name }}`), but `$item` is useful when you need to pass the whole object to an action.

```python
from prefab_ui.components import ForEach, Button
from prefab_ui import ToolCall

with ForEach("users"):
    # Fields available directly
    Text("{{ name }}")

    # $item useful for passing whole object to a tool
    Button("Edit", on_click=ToolCall(
        "edit_user",
        arguments={"user": "{{ $item }}"},
    ))
```

## Actions

Actions define what happens when a user interacts with a component. They are the mutation side of the system — expressions compute values for display, actions change state.

Actions fire from interaction props like `on_click`, `on_change`, and `on_submit`. Pass a single action or a list for sequential execution.

### Composing Actions

Pass a list to run multiple actions from one interaction. Actions execute in order, and the first failure stops the chain.

```python
from prefab_ui.components import Button
from prefab_ui import SetState, ToolCall, ShowToast

Button("Submit", on_click=[
    SetState("status", "saving..."),
    ToolCall("save", arguments={"data": "{{ formData }}"},
        on_error=ShowToast("Save failed: {{ $error }}", variant="error")),
    SetState("status", "saved"),
    ShowToast("Done!", variant="success"),
])
```

If `ToolCall` fails, its `on_error` fires, then `SetState("status", "saved")` and `ShowToast` are skipped.

### Lifecycle Callbacks

Every action supports `on_success` and `on_error` callbacks, which are themselves actions (recursive). This enables patterns like showing different toasts for success and failure of a server call.

### Client Actions

These execute instantly in the browser with no server round-trip.

#### SetState

Set a state variable. Defaults to capturing `$event` when no value is provided.

```python
from prefab_ui import SetState

SetState("theme", "dark")          # Explicit value
SetState("query")                   # Captures $event (e.g., input text)
SetState("count", "{{ count + 1 }}") # Computed value
```

#### Path Support

SetState accepts dot-path keys to update nested values, including items within arrays using `$index` from a ForEach context:

```python
from prefab_ui.components import ForEach, Checkbox
from prefab_ui import SetState

with ForEach("todos"):
    Checkbox(
        name="done",
        on_change=SetState("todos.{{ $index }}.done"),
    )
```

This updates the `done` field of the specific todo item at the current iteration index.

#### ToggleState

Flip a boolean. `true` becomes `false`, `false` becomes `true`.

```python
from prefab_ui import ToggleState

Button("Toggle sidebar", on_click=ToggleState("sidebarOpen"))
```

#### AppendState

Push a value onto the end of an array in state.

```python
from prefab_ui.components import Input, Button, Row
from prefab_ui import AppendState, SetState

with Row(gap=2):
    Input(name="newTodo", placeholder="What needs to be done?")
    Button("Add", on_click=[
        AppendState("todos", {"text": "{{ newTodo }}", "done": False}),
        SetState("newTodo", ""),
    ])
```

The value parameter supports interpolation — `{{ newTodo }}` resolves at dispatch time. After appending, the input is cleared by resetting `newTodo` to an empty string.

#### RemoveState

Remove an item from an array in state by index.

```python
from prefab_ui.components import ForEach, Button, Row, Text
from prefab_ui import RemoveState

with ForEach("todos"):
    with Row(gap=2, align="center"):
        Text("{{ text }}")
        Button("Delete", variant="ghost",
               on_click=RemoveState("todos", "{{ $index }}"))
```

Inside a ForEach, `{{ $index }}` gives the current item's position in the array.

#### ShowToast

Display a notification. Supports `success`, `error`, `warning`, and `info` variants.

```python
from prefab_ui import ShowToast

ShowToast("Saved successfully!", variant="success")
ShowToast("{{ $error }}", variant="error")
```

#### OpenLink

Open a URL through the host's link handler.

```python
from prefab_ui import OpenLink

Button("View docs", on_click=OpenLink("https://prefab-ui.dev"))
Button("View profile", on_click=OpenLink("https://example.com/{{ userId }}"))
```

### MCP Actions

These communicate with the host application and involve a server round-trip.

#### ToolCall

Call a server-side tool. Arguments support interpolation. Use `result_key` to write the tool's response into state for the UI to consume.

```python
from prefab_ui import ToolCall

Button("Search", on_click=ToolCall(
    "search",
    arguments={"query": "{{ searchInput }}"},
    result_key="results",
))
```

When the tool returns, the response data is written to `state["results"]` and any `{{ results }}` references re-render.

#### SendMessage

Send a message to the chat as if the user typed it.

```python
from prefab_ui import SendMessage

Button("Summarize", on_click=SendMessage("Summarize the data above."))
Button("Ask", on_click=SendMessage("{{ question }}"))
```

#### UpdateContext

Silently update what the model knows without triggering a response.

```python
from prefab_ui import UpdateContext

Button("Share context", on_click=UpdateContext(
    "The user selected {{ selectedItem }}."
))
```

## Grammar Reference

The complete expression grammar. Each level binds tighter than the one above it.

```
expr       -> ternary
ternary    -> or ( '?' expr ':' expr )?
or         -> and ( '||' and )*
and        -> not ( '&&' not )*
not        -> '!' not | comp
comp       -> add ( ( '==' | '!=' | '>' | '<' | '>=' | '<=' ) add )?
add        -> mul ( ( '+' | '-' ) mul )*
mul        -> pipe ( ( '*' | '/' ) pipe )*
pipe       -> primary ( '|' ident ( ':' arg )? )*
primary    -> '(' expr ')' | number | string | 'true' | 'false' | 'null' | ident
ident      -> name ( '.' name )*
```

Strings use single quotes inside expressions: `{{ status == 'active' }}`. Numbers can be integers or floats. Identifiers resolve as dot-paths against the current context.

## Design Boundaries

The expression language is intentionally small. Here's what's in scope and what isn't:

**Expressions handle:** computing display values — formatting, arithmetic, conditional text, comparisons, string building. Anything that derives a value from state for rendering.

**Actions handle:** mutating state — setting values, toggling booleans, appending to lists, removing from lists. Anything that changes what's in the state store.

**ToolCall handles:** everything else — complex logic, data fetching, list transformations, business rules. Anything that doesn't fit in the first two categories belongs on the server.

If you find yourself wanting to write application logic inside a `{{ }}` template, that's a sign the computation belongs in a ToolCall instead.
