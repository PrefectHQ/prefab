export const ComponentPreview = ({ json, height }) => {
  var minH = height ? parseInt(height, 10) : 0;
  const [frameHeight, setFrameHeight] = React.useState(minH);
  const iframeRef = React.useRef(null);

  React.useEffect(() => {
    const sendTheme = () => {
      var dark = document.documentElement.classList.contains("dark");
      var iframe = iframeRef.current;
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ type: "prefab:theme", dark: dark }, "*");
      }
    };

    const handler = (e) => {
      if (!e.data) return;
      if (e.data.type === "prefab:resize") {
        if (iframeRef.current && e.source === iframeRef.current.contentWindow) {
          setFrameHeight(function (prev) {
            return Math.max(e.data.height, minH);
          });
        }
      }
      if (e.data.type === "prefab:ready") {
        sendTheme();
      }
    };

    window.addEventListener("message", handler);

    var observer = new MutationObserver(sendTheme);
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ["class"] });

    return () => {
      window.removeEventListener("message", handler);
      observer.disconnect();
    };
  }, []);

  return (
    <Card>
      <iframe
        ref={iframeRef}
        data-docpreview
        src={"http://localhost:3333/renderer.html#docpreview:" + encodeURIComponent(json)}
        style={{ width: "100%", height: frameHeight + "px", border: "none", display: "block" }}
      />
    </Card>
  );
};
