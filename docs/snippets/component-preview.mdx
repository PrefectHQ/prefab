export const ComponentPreview = ({ json, height, resizable, bare, hideJson, children }) => {
  const hostRef = React.useRef(null);
  const handleRef = React.useRef(null);
  const cardRef = React.useRef(null);
  const containerRef = React.useRef(null);
  const [previewWidth, setPreviewWidth] = React.useState(null);
  const [isDragging, setIsDragging] = React.useState(false);

  var jsonStr = typeof json === "string" ? json : JSON.stringify(json, null, 2);

  React.useEffect(function () {
    if (cardRef.current) {
      var card = cardRef.current.closest(".group");
      if (card) card.classList.remove("group");
    }

    var host = hostRef.current;
    if (!host || !json) return;

    function mount() {
      if (!window.__prefab || !host) return;
      var dark = document.documentElement.classList.contains("dark");
      handleRef.current = window.__prefab.mountPreview(host, jsonStr, { dark: dark });
      if (bare && host.shadowRoot) {
        var m = host.shadowRoot.querySelector("[data-prefab-mount]");
        if (m) m.style.background = "transparent";
      }
    }

    if (window.__prefab) {
      mount();
    } else {
      if (!window.__prefabLoading) {
        window.__prefabLoading = new Promise(function (resolve, reject) {
          var s = document.createElement("script");
          s.type = "module";
          var isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
          s.src = isLocal
            ? "/renderer.js"
            : "https://cdn.jsdelivr.net/npm/@prefecthq/prefab-ui@0.2.0/dist/renderer.js";
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }
      window.__prefabLoading.then(mount);
    }

    var observer = new MutationObserver(function () {
      var dark = document.documentElement.classList.contains("dark");
      if (handleRef.current) handleRef.current.setDark(dark);
    });
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    return function () {
      observer.disconnect();
      if (handleRef.current) {
        handleRef.current.unmount();
        handleRef.current = null;
      }
    };
  }, [json]);

  function startResize(e) {
    e.preventDefault();
    var startX = e.clientX;
    var startW = hostRef.current ? hostRef.current.offsetWidth : 0;
    var maxW = containerRef.current
      ? containerRef.current.offsetWidth - 10
      : startW;

    setIsDragging(true);

    function onMove(ev) {
      var w = Math.max(260, Math.min(startW + (ev.clientX - startX), maxW));
      setPreviewWidth(w);
    }

    function onUp() {
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      setIsDragging(false);
    }

    document.addEventListener("mousemove", onMove);
    document.addEventListener("mouseup", onUp);
  }

  if (bare) {
    return <div ref={hostRef} />;
  }

  if (resizable) {
    return (
      <Card>
        <div ref={cardRef} />
        <div
          ref={containerRef}
          style={{ display: "flex", position: "relative", overflow: "hidden" }}
        >
          <div
            ref={hostRef}
            style={{
              flex: previewWidth ? "none" : 1,
              width: previewWidth ? previewWidth + "px" : undefined,
              minWidth: 0,
            }}
          />
          <div
            onMouseDown={startResize}
            style={{
              width: "14px",
              flexShrink: 0,
              cursor: "col-resize",
              background: isDragging
                ? "var(--border, #e5e7eb)"
                : "color-mix(in srgb, var(--border, #e5e7eb) 40%, transparent)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              transition: "background 0.15s",
              userSelect: "none",
            }}
          >
            <svg width="6" height="24" style={{ opacity: 0.5 }}>
              <circle cx="2" cy="4" r="1.2" fill="currentColor" />
              <circle cx="2" cy="9" r="1.2" fill="currentColor" />
              <circle cx="2" cy="14" r="1.2" fill="currentColor" />
              <circle cx="2" cy="19" r="1.2" fill="currentColor" />
              <circle cx="5" cy="4" r="1.2" fill="currentColor" />
              <circle cx="5" cy="9" r="1.2" fill="currentColor" />
              <circle cx="5" cy="14" r="1.2" fill="currentColor" />
              <circle cx="5" cy="19" r="1.2" fill="currentColor" />
            </svg>
          </div>
          <div
            style={{
              flex: previewWidth ? 1 : "0 0 24px",
              minWidth: "24px",
              background:
                "repeating-linear-gradient(-45deg, transparent, transparent 3px, var(--border, #e5e7eb) 3px, var(--border, #e5e7eb) 4px)",
              opacity: 0.3,
            }}
          />
          {previewWidth && (
            <div
              style={{
                position: "absolute",
                bottom: "8px",
                right: "8px",
                background: "var(--background, white)",
                border: "1px solid var(--border, #e5e7eb)",
                borderRadius: "4px",
                padding: "1px 6px",
                fontSize: "11px",
                fontFamily: "monospace",
                color: "var(--muted-foreground, #6b7280)",
                pointerEvents: "none",
              }}
            >
              {previewWidth}px
            </div>
          )}
        </div>
        <div style={{ marginBottom: "-2rem" }}>{children}</div>
      </Card>
    );
  }

  return (
    <Card>
      <div ref={cardRef} />
      <div ref={hostRef} />
      <div style={{ marginBottom: "-2rem" }}>{children}</div>
    </Card>
  );
};
