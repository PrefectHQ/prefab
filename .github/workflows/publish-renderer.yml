# Publishes @prefecthq/prefab-ui to npm on release.
#
# Currently Mintlify loads renderer.js from the repo (committed by
# build-renderer.yml on PR). Once we're cutting regular releases, we
# should switch published docs to load from the npm CDN instead and
# stop committing renderer.js to git. The CDN fallback in
# component-preview.mdx already supports this — just remove
# docs/renderer.js from the repo and gitignore it.
name: Publish renderer to npm

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: "Build & publish @prefecthq/prefab-ui"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: renderer/package-lock.json
          registry-url: "https://registry.npmjs.org"

      - name: Set npm version from git tag
        working-directory: renderer
        run: |
          # Strip PEP 440 pre-release suffix: v0.1.0a1 → 0.1.0
          RAW="${{ github.ref_name }}"
          VERSION="${RAW#v}"
          VERSION=$(echo "$VERSION" | sed -E 's/(a|b|rc)[0-9]+$//')
          npm version "$VERSION" --no-git-tag-version

      - run: npm ci
        working-directory: renderer

      - run: npm run build:publish
        working-directory: renderer

      - run: npm publish --access public --tag latest
        working-directory: renderer
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
