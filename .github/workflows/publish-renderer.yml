# Publishes @prefecthq/prefab-ui to npm on release.
#
# Currently Mintlify loads renderer.js from the repo (committed by
# build-renderer.yml on PR). Once we're cutting regular releases, we
# should switch published docs to load from the npm CDN instead and
# stop committing renderer.js to git. The CDN fallback in
# component-preview.mdx already supports this â€” just remove
# docs/renderer.js from the repo and gitignore it.
name: Publish renderer to npm

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    name: "Build & publish @prefecthq/prefab-ui"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: renderer/package-lock.json
          registry-url: "https://registry.npmjs.org"

      - name: Set npm version from git tag
        working-directory: renderer
        run: |
          # Convert git tag (e.g. v0.1.0a1) to semver (e.g. 0.1.0-alpha.1)
          RAW="${{ github.ref_name }}"
          VERSION="${RAW#v}"
          VERSION=$(echo "$VERSION" | sed -E 's/a([0-9]+)/-alpha.\1/; s/b([0-9]+)/-beta.\1/; s/rc([0-9]+)/-rc.\1/')
          npm version "$VERSION" --no-git-tag-version

      - run: npm ci
        working-directory: renderer

      - run: npm run build:publish
        working-directory: renderer

      - name: Derive npm dist-tag
        id: npm-tag
        working-directory: renderer
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [[ "$VERSION" == *"-alpha"* ]]; then TAG=alpha
          elif [[ "$VERSION" == *"-beta"* ]]; then TAG=beta
          elif [[ "$VERSION" == *"-rc"* ]]; then TAG=next
          else TAG=latest
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - run: npm publish --access public --tag ${{ steps.npm-tag.outputs.tag }}
        working-directory: renderer
