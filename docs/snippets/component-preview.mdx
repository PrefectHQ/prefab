export const ComponentPreview = ({ json, height, children }) => {
  const hostRef = React.useRef(null);
  const handleRef = React.useRef(null);
  const cardRef = React.useRef(null);

  React.useEffect(() => {
    if (cardRef.current) {
      var card = cardRef.current.closest(".group");
      if (card) card.classList.remove("group");
    }

    var host = hostRef.current;
    if (!host) return;

    function mount() {
      if (!window.__prefab || !host) return;
      var dark = document.documentElement.classList.contains("dark");
      handleRef.current = window.__prefab.mountPreview(host, json, { dark: dark });
    }

    if (window.__prefab) {
      mount();
    } else {
      if (!window.__prefabLoading) {
        window.__prefabLoading = new Promise(function (resolve, reject) {
          var s = document.createElement("script");
          s.src = "https://unpkg.com/@prefecthq/prefab-ui@latest/dist/renderer.js";
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }
      window.__prefabLoading.then(mount);
    }

    var observer = new MutationObserver(() => {
      var dark = document.documentElement.classList.contains("dark");
      if (handleRef.current) handleRef.current.setDark(dark);
    });
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    return () => {
      observer.disconnect();
      if (handleRef.current) {
        handleRef.current.unmount();
        handleRef.current = null;
      }
    };
  }, []);

  return (
    <Card>
      <div ref={cardRef} />
      <div ref={hostRef} />
      <div style={{ marginBottom: "-2rem" }}>{children}</div>
    </Card>
  );
};
